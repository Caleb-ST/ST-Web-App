<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Repairs Tracker</title>

  <style>
    body { font-family: Arial, sans-serif; max-width: 1100px; margin: 20px auto; padding: 0 12px; }
    h1 { margin: 0 0 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: top; }
    th { background: #fafafa; position: sticky; top: 0; }
    input, select, button, textarea { padding: 8px; font: inherit; }
    button { cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 10px 0; }
    .muted { color:#666; font-size: 0.9em; }
    .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; background:#eee; font-size: 0.85em; }
    .pill.stagnant { background:#ffe3e3; }
    .right { margin-left:auto; }
    label { font-size: 0.9em; color:#333; }
    textarea { line-height: 1.3; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <h1>Repairs Tracker</h1>

  <!-- AUTH -->
  <div class="row">
    <input id="email" placeholder="email" autocomplete="username" />
    <input id="password" type="password" placeholder="password" autocomplete="current-password" />
    <button id="loginBtn">Login</button>

    <button id="logoutBtn" style="display:none;">Logout</button>
    <span id="authStatus" class="muted"></span>
  </div>

  <!-- CONTROLS -->
  <div class="row" id="controls" style="display:none;">
    <input id="search" placeholder="Search customer / brand / model / serial / fault..." style="flex:1; min-width: 260px;" />

    <select id="statusFilter">
      <option value="">All statuses</option>
      <option>Received</option>
      <option>Diagnosing</option>
      <option>Awaiting Approval</option>
      <option>Awaiting Parts</option>
      <option>In Repair</option>
      <option>Testing / QA</option>
      <option>Ready for Pickup</option>
      <option>Completed</option>
      <option>Sent to Supplier</option>
      <option>Cancelled</option>
    </select>

    <button id="refreshBtn">Refresh</button>
  </div>

  <!-- ACTIONS -->
  <div class="row" id="actions" style="display:none;">
    <button id="addJobOpenBtn">+ Add Job</button>
    <span class="muted">Stagnant = no updates in 7 days.</span>
  </div>

  <!-- TABLE -->
  <div id="tableWrap"></div>

  <!-- ADD JOB MODAL -->
  <div id="modalBackdrop" style="
    display:none;
    position:fixed; inset:0;
    background:rgba(0,0,0,0.55);
    padding:20px;
    z-index:9999;
  ">
    <div id="addJobModal" style="
      max-width:720px;
      margin:40px auto;
      background:#fff;
      border-radius:12px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    ">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <h2 style="margin:0;">Create Repair Job</h2>
        <button id="addJobCloseBtn" title="Close">✕</button>
      </div>

      <p class="muted" style="margin-top:6px;">Fill the basics now. Add details and updates later.</p>

      <form id="addJobForm">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px;">
          <div>
            <label>Customer Name *</label><br />
            <input id="f_customer" required style="width:100%;" />
          </div>
          <div>
            <label>Contact</label><br />
            <input id="f_contact" placeholder="Phone or email" style="width:100%;" />
          </div>

          <div>
            <label>Store</label><br />
            <input id="f_store" placeholder="e.g. Windsor Gardens" style="width:100%;" />
          </div>
          <div>
            <label>Priority</label><br />
            <select id="f_priority" style="width:100%;">
              <option>Normal</option>
              <option>High</option>
              <option>Low</option>
            </select>
          </div>

          <div>
            <label>Brand</label><br />
            <input id="f_brand" style="width:100%;" />
          </div>
          <div>
            <label>Model</label><br />
            <input id="f_model" style="width:100%;" />
          </div>

          <div>
            <label>Serial</label><br />
            <input id="f_serial" style="width:100%;" />
          </div>
          <div>
            <label>Status</label><br />
            <select id="f_status" style="width:100%;">
              <option>Received</option>
              <option>Diagnosing</option>
              <option>Awaiting Approval</option>
              <option>Awaiting Parts</option>
              <option>In Repair</option>
              <option>Testing / QA</option>
              <option>Ready for Pickup</option>
              <option>Completed</option>
              <option>Sent to Supplier</option>
              <option>Cancelled</option>
            </select>
          </div>

          <div style="grid-column: 1 / -1;">
            <label>Fault / Notes</label><br />
            <textarea id="f_fault" rows="4" style="width:100%; resize:vertical;"></textarea>
          </div>
        </div>

        <div class="row" style="justify-content:flex-end; margin-top:14px;">
          <button type="button" id="addJobCancelBtn">Cancel</button>
          <button type="submit" id="addJobSaveBtn">Save Job</button>
        </div>

        <p id="addJobMsg" class="muted" style="margin:6px 0 0;"></p>
      </form>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // Supabase config (you gave me these)
    const SUPABASE_URL = "https://flkxfnvsqionfubdhgzg.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsa3hmbnZzcWlvbmZ1YmRoZ3pnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2ODEyNDIsImV4cCI6MjA4NDI1NzI0Mn0.LA70lh7faDaDO18VJItv-ob6M8c9NbR4LtxIFGuFUoM";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    const el = (id) => document.getElementById(id);

    const authStatus = el("authStatus");
    const controls = el("controls");
    const actions = el("actions");
    const logoutBtn = el("logoutBtn");

    const tableWrap = el("tableWrap");

    // ---- Helpers ----
    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function isStagnant(lastUpdatedISO, days = 7) {
      const ms = Date.now() - new Date(lastUpdatedISO).getTime();
      return ms > days * 24 * 60 * 60 * 1000;
    }

    function fmtDate(iso) {
      try { return new Date(iso).toLocaleString(); }
      catch { return String(iso ?? ""); }
    }

    // ---- Auth UI ----
    async function setUIForAuth() {
      const { data: { session } } = await supabase.auth.getSession();

      if (session) {
        authStatus.textContent = `Logged in as ${session.user.email}`;
        controls.style.display = "";
        actions.style.display = "";
        logoutBtn.style.display = "";
        await loadJobs(false);
      } else {
        authStatus.textContent = "Not logged in";
        controls.style.display = "none";
        actions.style.display = "none";
        logoutBtn.style.display = "none";
        tableWrap.innerHTML = "";
      }
    }

    el("loginBtn").addEventListener("click", async () => {
      const email = el("email").value.trim();
      const password = el("password").value;

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);

      await setUIForAuth();
    });

    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      await setUIForAuth();
    });

    el("refreshBtn").addEventListener("click", () => loadJobs(false));
    el("search").addEventListener("input", () => loadJobs(true));
    el("statusFilter").addEventListener("change", () => loadJobs(true));

    // ---- Jobs list ----
    let allJobs = [];

    async function loadJobs(fromCacheFilter = false) {
      if (!fromCacheFilter) {
        const { data, error } = await supabase
          .from("jobs")
          .select("*")
          .order("last_updated_at", { ascending: false });

        if (error) {
          tableWrap.innerHTML = `<p class="muted">Error loading jobs: ${escapeHtml(error.message)}</p>`;
          return;
        }

        allJobs = data ?? [];
      }

      const q = el("search").value.trim().toLowerCase();
      const status = el("statusFilter").value;

      const filtered = allJobs.filter(j => {
        const hay = [
          j.id,
          j.customer_name,
          j.contact,
          j.store,
          j.brand,
          j.model,
          j.serial,
          j.fault,
          j.status,
          j.priority
        ].join(" ").toLowerCase();

        const qOk = !q || hay.includes(q);
        const sOk = !status || j.status === status;
        return qOk && sOk;
      });

      renderJobs(filtered);
    }

    function renderJobs(jobs) {
      if (!jobs.length) {
        tableWrap.innerHTML = `<p class="muted">No jobs found.</p>`;
        return;
      }

      const rows = jobs.map(j => {
        const stagnant = isStagnant(j.last_updated_at, 7);
        const stagnantPill = stagnant ? `<span class="pill stagnant">stagnant</span>` : "";
        const prioPill = j.priority ? `<span class="pill">${escapeHtml(j.priority)}</span>` : "";

        return `
          <tr>
            <td>
              <div><strong>${escapeHtml(j.customer_name)}</strong></div>
              <div class="muted">${escapeHtml(j.contact ?? "")}</div>
              <div class="muted">${escapeHtml(j.store ?? "")}</div>
            </td>
            <td>
              <div>${escapeHtml([j.brand, j.model].filter(Boolean).join(" "))}</div>
              <div class="muted mono">${escapeHtml(j.serial ?? "")}</div>
            </td>
            <td>
              <div><strong>${escapeHtml(j.status)}</strong></div>
              <div class="row" style="margin:6px 0 0; gap:6px;">
                ${stagnantPill}
                ${prioPill}
              </div>
            </td>
            <td>${escapeHtml(j.fault ?? "")}</td>
            <td class="muted">${escapeHtml(fmtDate(j.last_updated_at))}</td>
          </tr>
        `;
      }).join("");

      tableWrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th style="width: 22%;">Customer</th>
              <th style="width: 20%;">Item</th>
              <th style="width: 16%;">Status</th>
              <th>Fault / Notes</th>
              <th style="width: 16%;">Last Updated</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    // ---- Realtime refresh (optional but nice) ----
    supabase.channel("jobs-realtime")
      .on("postgres_changes", { event: "*", schema: "public", table: "jobs" }, () => loadJobs(false))
      .subscribe();

    // ---- Add Job modal ----
    const backdrop = el("modalBackdrop");
    const msg = el("addJobMsg");

    function openModal() {
      msg.textContent = "";
      backdrop.style.display = "";
      document.body.style.overflow = "hidden";
      el("f_customer").focus();
    }

    function closeModal() {
      backdrop.style.display = "none";
      document.body.style.overflow = "";
      el("addJobForm").reset();
      el("f_priority").value = "Normal";
      el("f_status").value = "Received";
    }

    el("addJobOpenBtn").addEventListener("click", openModal);
    el("addJobCloseBtn").addEventListener("click", closeModal);
    el("addJobCancelBtn").addEventListener("click", closeModal);

    backdrop.addEventListener("click", (e) => {
      if (e.target === backdrop) closeModal();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && backdrop.style.display !== "none") closeModal();
    });

    el("addJobForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const saveBtn = el("addJobSaveBtn");
      saveBtn.disabled = true;
      msg.textContent = "Saving…";

      try {
        const customer_name = el("f_customer").value.trim();
        if (!customer_name) throw new Error("Customer Name is required.");

        const job = {
          customer_name,
          contact: el("f_contact").value.trim() || null,
          store: el("f_store").value.trim() || null,
          brand: el("f_brand").value.trim() || null,
          model: el("f_model").value.trim() || null,
          serial: el("f_serial").value.trim() || null,
          fault: el("f_fault").value.trim() || null,
          priority: el("f_priority").value,
          status: el("f_status").value,
          last_updated_at: new Date().toISOString()
        };

        const { error } = await supabase
          .from("jobs")
          .insert([job]);

        if (error) throw error;

        msg.textContent = "Saved.";
        await loadJobs(false);
        closeModal();
      } catch (err) {
        msg.textContent = err?.message ?? String(err);
      } finally {
        saveBtn.disabled = false;
      }
    });

    // Initialize UI
    setUIForAuth();
  </script>
</body>
</html>
